<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>UIView二三事 | iOS Developer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="UIView 是iOS中不可或缺的一部分，所有视图的呈现都要靠 UIView">
<meta property="og:type" content="article">
<meta property="og:title" content="UIView二三事">
<meta property="og:url" content="http://yoursite.com/2017/02/27/UIView二三事/index.html">
<meta property="og:site_name" content="iOS Developer">
<meta property="og:description" content="UIView 是iOS中不可或缺的一部分，所有视图的呈现都要靠 UIView">
<meta property="og:image" content="https://ww1.sinaimg.cn/large/006tKfTcly1fd516o39txj30f40b274c.jpg">
<meta property="og:image" content="https://ww4.sinaimg.cn/large/006tKfTcly1fd67nnw7puj30kg0943yi.jpg">
<meta property="og:updated_time" content="2017-03-22T07:22:20.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="UIView二三事">
<meta name="twitter:description" content="UIView 是iOS中不可或缺的一部分，所有视图的呈现都要靠 UIView">
<meta name="twitter:image" content="https://ww1.sinaimg.cn/large/006tKfTcly1fd516o39txj30f40b274c.jpg">
  
    <link rel="alternate" href="/atom.xml" title="iOS Developer" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">iOS Developer</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">Hello World</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-UIView二三事" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/02/27/UIView二三事/" class="article-date">
  <time datetime="2017-02-27T08:00:48.000Z" itemprop="datePublished">2017-02-27</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/iOS/">iOS</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      UIView二三事
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>iOS 当中一些偷懒的写法，简单快捷，，其实是利用了一些底层的一些特性</p>
<p>1、直接在 UIView 视图上显示一个 image</p>
<blockquote>
<p>UIView *layerView = [[UIView alloc] initWithFrame:CGRectMake(50, 200, __MainScreen_Width - 100, 200)];</p>
<p>layerView.backgroundColor = [UIColor orangeColor];</p>
<p>[self.window addSubview:layerView];</p>
<p>UIImage *img = [UIImage imageNamed:@”001”];</p>
<p>layerView.layer.contents = (__bridge id _Nullable)(img.CGImage);</p>
<p>//layerView.contentMode = UIViewContentModeScaleAspectFit; //和下边的语句等同</p>
<p>layerView.layer.contentsGravity = kCAGravityResizeAspect;</p>
</blockquote>
<p> 效果如下图：</p>
<p><img src="https://ww1.sinaimg.cn/large/006tKfTcly1fd516o39txj30f40b274c.jpg" alt=""></p>
<p>苹果建议：如果没有自定义绘制的任务就不要在子类中写一个空的<code>-drawRect:</code>方法。</p>
<h3 id="视图的几何属性"><a href="#视图的几何属性" class="headerlink" title="视图的几何属性"></a>视图的几何属性</h3><p>视图有 frame，center，bounds 等几个基本几何属性，其中:</p>
<ul>
<li>frame 使用的最多，其坐标位置都是相对于父视图的，可以用于确定本视图在父视图中的位置和其自身的大小</li>
<li>center 的坐标位置也是相对于父视图的，通常用于移动，旋转等动画操作</li>
<li>bounds 是相对于自身的，通常情况下就是（0,0,width,height)， bounds 的含义可以认为是当前 view 被允许绘制的范围</li>
</ul>
<h2 id="布局"><a href="#布局" class="headerlink" title="布局"></a>布局</h2><p><code>UIView</code>有三个比较重要的布局属性：<code>frame</code>，<code>bounds</code>和<code>center</code>，<code>CALayer</code>对应地叫做<code>frame</code>，<code>bounds</code>和<code>position</code>。为了能清楚区分，图层用了“position”，视图用了“center”，但是他们都代表同样的值。</p>
<p><code>frame</code>代表了图层的外部坐标（也就是在父图层上占据的空间），<code>bounds</code>是内部坐标（{0, 0}通常是图层的左上角），<code>center</code>和<code>position</code>都代表了相对于父图层<code>anchorPoint</code>所在的位置。</p>
<p>视图的<code>frame</code>，<code>bounds</code>和<code>center</code>属性仅仅是<em>存取方法</em>，当操纵视图的<code>frame</code>，实际上是在改变位于视图下方<code>CALayer</code>的<code>frame</code>，不能够独立于图层之外改变视图的<code>frame</code>。</p>
<p>对于视图或者图层来说，<code>frame</code>并不是一个非常清晰的属性，它其实是一个虚拟属性，是根据<code>bounds</code>，<code>position</code>和<code>transform</code>计算而来，所以当其中任何一个值发生改变，frame都会变化。相反，改变frame的值同样会影响到他们当中的值</p>
<p>记住当对图层做变换的时候，比如旋转或者缩放，<code>frame</code>实际上代表了覆盖在图层旋转之后的整个轴对齐的矩形区域，也就是说<code>frame</code>的宽高可能和<code>bounds</code>的宽高不再一致了</p>
<h3 id="动画"><a href="#动画" class="headerlink" title="动画"></a>动画</h3><p>可以以动画的形式改变视图的下面这些属性，只需要告诉系统动画开始和结束时的数值，<strong>系统会自动处理中间的过渡过程</strong>。</p>
<ul>
<li>frame</li>
<li>bounds</li>
<li>center</li>
<li>transform</li>
<li>alpha</li>
<li>backgroundColor</li>
<li>contentStretch</li>
</ul>
<h2 id="锚点"><a href="#锚点" class="headerlink" title="锚点"></a>锚点</h2><p><code>anchorPoint</code>是锚点。视图的<code>center</code>属性和图层的<code>position</code>属性都指定了<code>anchorPoint</code>相对于父图层的位置。图层的<code>anchorPoint</code>通过<code>position</code>来控制它的<code>frame</code>的位置，你可以认为<code>anchorPoint</code>是用来移动图层的<em>把柄</em>。</p>
<p>默认来说，<code>anchorPoint</code>位于图层的中点，所以图层将会以这个点为中心放置。<code>anchorPoint</code>属性并没有被<code>UIView</code>接口暴露出来，这也是视图的position属性被叫做“center”的原因。但是图层的<code>anchorPoint</code>可以被移动，比如你可以把它置于图层<code>frame</code>的左上角，于是图层的内容将会向右下角的<code>position</code>方向移动，而不是居中了。</p>
<h2 id="坐标系"><a href="#坐标系" class="headerlink" title="坐标系"></a>坐标系</h2><p>和视图一样，图层在图层树当中也是相对于父图层按层级关系放置，一个图层的<code>position</code>依赖于它父图层的<code>bounds</code>，如果父图层发生了移动，它的所有子图层也会跟着移动。</p>
<p>这样对于放置图层会更加方便，因为你可以通过移动根图层来将它的子图层作为一个整体来移动，但是有时候你需要知道一个图层的<em>绝对</em>位置，或者是相对于另一个图层的位置，而不是它当前父图层的位置。</p>
<p><code>CALayer</code>给不同坐标系之间的图层转换提供了一些工具类方法：</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">- <span class="params">(CGPoint)</span>convertPoint:<span class="params">(CGPoint)</span>point fromLayer:<span class="params">(CALayer *)</span>layer; </div><div class="line">- <span class="params">(CGPoint)</span>convertPoint:<span class="params">(CGPoint)</span>point toLayer:<span class="params">(CALayer *)</span>layer; </div><div class="line">- <span class="params">(CGRect)</span>convertRect:<span class="params">(CGRect)</span>rect fromLayer:<span class="params">(CALayer *)</span>layer;</div><div class="line">- <span class="params">(CGRect)</span>convertRect:<span class="params">(CGRect)</span>rect toLayer:<span class="params">(CALayer *)</span>layer;</div></pre></td></tr></table></figure>
<p>这些方法可以把定义在一个图层坐标系下的点或者矩形转换成另一个图层坐标系下的点或者矩形</p>
<p>常规说来，在iOS上，一个图层的<code>position</code>位于父图层的左上角，但是在Mac OS上，通常是位于左下角。Core Animation可以通过<code>geometryFlipped</code>属性来适配这两种情况，它决定了一个图层的坐标是否相对于父图层垂直翻转，是一个<code>BOOL</code>类型。在iOS上通过设置它为<code>YES</code>意味着它的子图层将会被垂直翻转，也就是将会沿着底部排版而不是通常的顶部（它的所有子图层也同理，除非把它们的<code>geometryFlipped</code>属性也设为<code>YES</code>）。</p>
<p><code>CALayer</code>并不关心任何响应链事件，所以不能直接处理触摸事件或者手势。但是它有一系列的方法帮你处理事件：<code>-containsPoint:</code>和<code>-hitTest:</code>。</p>
<p><code>-containsPoint:</code>接受一个在本图层坐标系下的<code>CGPoint</code>，如果这个点在图层<code>frame</code>范围内就返回<code>YES</code>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">- (void)touchesBegan:(NSSet *)touches withEvent:(UIEvent *)event</div><div class="line">&#123;</div><div class="line">    //get touch position relative to main view</div><div class="line">    CGPoint point = [[touches anyObject] locationInView:self.view];</div><div class="line">    //convert point to the white layer&apos;s coordinates</div><div class="line">    point = [self.layerView.layer convertPoint:point fromLayer:self.view.layer];</div><div class="line">    //get layer using containsPoint:</div><div class="line">    if ([self.layerView.layer containsPoint:point]) &#123;</div><div class="line">        //convert point to blueLayer’s coordinates</div><div class="line">        point = [self.blueLayer convertPoint:point fromLayer:self.layerView.layer];</div><div class="line">        if ([self.blueLayer containsPoint:point]) &#123;</div><div class="line">            [[[UIAlertView alloc] initWithTitle:@&quot;Inside Blue Layer&quot; </div><div class="line">                                        message:nil</div><div class="line">                                       delegate:nil </div><div class="line">                              cancelButtonTitle:@&quot;OK&quot;</div><div class="line">                              otherButtonTitles:nil] show];</div><div class="line">        &#125; else &#123;</div><div class="line">            [[[UIAlertView alloc] initWithTitle:@&quot;Inside White Layer&quot;</div><div class="line">                                        message:nil </div><div class="line">                                       delegate:nil</div><div class="line">                              cancelButtonTitle:@&quot;OK&quot;</div><div class="line">                              otherButtonTitles:nil] show];</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>-hitTest:</code>方法同样接受一个<code>CGPoint</code>类型参数，而不是<code>BOOL</code>类型，它返回图层本身，或者包含这个坐标点的叶子节点图层。这意味着不再需要像使用<code>-containsPoint:</code>那样，人工地在每个子图层变换或者测试点击的坐标。如果这个点在最外面图层的范围之外，则返回nil。具体使用<code>-hitTest:</code>方法被点击图层的代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">- (void)touchesBegan:(NSSet *)touches withEvent:(UIEvent *)event</div><div class="line">&#123;</div><div class="line">    //get touch position</div><div class="line">    CGPoint point = [[touches anyObject] locationInView:self.view];</div><div class="line">    //get touched layer</div><div class="line">    CALayer *layer = [self.layerView.layer hitTest:point];</div><div class="line">    //get layer using hitTest</div><div class="line">    if (layer == self.blueLayer) &#123;</div><div class="line">        [[[UIAlertView alloc] initWithTitle:@&quot;Inside Blue Layer&quot;</div><div class="line">                                    message:nil</div><div class="line">                                   delegate:nil</div><div class="line">                          cancelButtonTitle:@&quot;OK&quot;</div><div class="line">                          otherButtonTitles:nil] show];</div><div class="line">    &#125; else if (layer == self.layerView.layer) &#123;</div><div class="line">        [[[UIAlertView alloc] initWithTitle:@&quot;Inside White Layer&quot;</div><div class="line">                                    message:nil</div><div class="line">                                   delegate:nil</div><div class="line">                          cancelButtonTitle:@&quot;OK&quot;</div><div class="line">                          otherButtonTitles:nil] show];</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>注意当调用图层的<code>-hitTest:</code>方法时，测算的顺序严格依赖于图层树当中的图层顺序（和UIView处理事件类似）。</p>
<h2 id="阴影"><a href="#阴影" class="headerlink" title="阴影"></a>阴影</h2><p>iOS的另一个常见特性呢，就是阴影。阴影往往可以达到图层深度暗示的效果。</p>
<p>给<code>shadowOpacity</code>属性一个大于默认值（也就是0）的值，阴影就可以显示在任意图层之下。<code>shadowOpacity</code>是一个必须在0.0（不可见）和1.0（完全不透明）之间的浮点数。如果设置为1.0，将会显示一个有轻微模糊的黑色阴影稍微在图层之上。若要改动阴影的表现，你可以使用CALayer的另外三个属性：<code>shadowColor</code>，<code>shadowOffset</code>和<code>shadowRadius</code>。</p>
<p>显而易见，<code>shadowColor</code>属性控制着阴影的颜色，和<code>borderColor</code>和<code>backgroundColor</code>一样，它的类型也是<code>CGColorRef</code>。阴影默认是黑色，大多数时候你需要的阴影也是黑色的（其他颜色的阴影看起来是不是有一点点奇怪。。）。</p>
<p><code>shadowOffset</code>属性控制着阴影的方向和距离。它是一个<code>CGSize</code>的值，宽度控制着阴影横向的位移，高度控制着纵向的位移。<code>shadowOffset</code>的默认值是 {0, -3}，意即阴影相对于Y轴有3个点的向上位移。</p>
<p>为什么要默认向上的阴影呢？尽管Core Animation是从图层套装演变而来（可以认为是为iOS创建的私有动画框架），但是呢，它却是在Mac OS上面世的，前面有提到，二者的Y轴是颠倒的。这就导致了默认的3个点位移的阴影是向上的。在Mac上，<code>shadowOffset</code>的默认值是阴影向下的，这样你就能理解为什么iOS上的阴影方向是向上的了😁</p>
<p><code>shadowRadius</code>属性控制着阴影的<em>模糊度</em>，当它的值是0的时候，阴影就和视图一样有一个非常确定的边界线。当值越来越大的时候，边界线看上去就会越来越模糊和自然。苹果自家的应用设计更偏向于自然的阴影，所以一个非零值再合适不过了。通常来讲，如果你想让视图或控件非常醒目独立于背景之外（比如弹出框遮罩层），你就应该给<code>shadowRadius</code>设置一个稍大的值。阴影越模糊，图层的深度看上去就会更明显。。</p>
<p>当阴影和裁剪扯上关系的时候就有一个头疼的限制：阴影通常就是在Layer的边界之外，如果你开启了<code>masksToBounds</code>属性，所有从图层中突出来的内容都会被才剪掉。</p>
<h2 id="shadowPath属性"><a href="#shadowPath属性" class="headerlink" title="shadowPath属性"></a><code>shadowPath</code>属性</h2><p><code>shadowPath</code>是一个<code>CGPathRef</code>类型（一个指向<code>CGPath</code>的指针）。<code>CGPath</code>是一个Core Graphics对象，用来指定任意的一个矢量图形。我们可以通过这个属性单独于图层形状之外指定阴影的形状。</p>
<p><img src="https://ww4.sinaimg.cn/large/006tKfTcly1fd67nnw7puj30kg0943yi.jpg" alt=""></p>
<blockquote>
<p>//enable layer shadows<br>  self.layerView1.layer.shadowOpacity = 0.5f;<br>  self.layerView2.layer.shadowOpacity = 0.5f;</p>
<p>  //create a square shadow<br>  CGMutablePathRef squarePath = CGPathCreateMutable();<br>  CGPathAddRect(squarePath, NULL, self.layerView1.bounds);<br>  self.layerView1.layer.shadowPath = squarePath; CGPathRelease(squarePath);</p>
<p>  ￼//create a circular shadow<br>  CGMutablePathRef circlePath = CGPathCreateMutable();<br>  CGPathAddEllipseInRect(circlePath, NULL, self.layerView2.bounds);<br>  self.layerView2.layer.shadowPath = circlePath; CGPathRelease(circlePath);</p>
</blockquote>
<p>如果是一个矩形或者是圆，用<code>CGPath</code>会相当简单明了。但是如果是更加复杂一点的图形，<code>UIBezierPath</code>类会更合适，它是一个由UIKit提供的在CGPath基础上的Objective-C包装类。</p>
<h2 id="图层蒙板"><a href="#图层蒙板" class="headerlink" title="图层蒙板"></a>图层蒙板</h2><p>通过<code>masksToBounds</code>属性，我们可以沿边界裁剪图形；通过<code>cornerRadius</code>属性，我们还可以设定一个圆角。但是有时候你希望展现的内容不是在一个矩形或圆角矩形。比如，你想展示一个有星形框架的图片，又或者想让一些古卷文字慢慢渐变成背景色，而不是一个突兀的边界。</p>
<p>使用一个32位有alpha通道的png图片通常是创建一个无矩形视图最方便的方法，你可以给它指定一个透明蒙板来实现。但是这个方法不能让你以编码的方式动态地生成蒙板，也不能让子图层或子视图裁剪成同样的形状。</p>
<p>CALayer有一个属性叫做<code>mask</code>可以解决这个问题。这个属性本身就是个CALayer类型，有和其他图层一样的绘制和布局属性。它类似于一个子图层，相对于父图层（即拥有该属性的图层）布局，但是它却不是一个普通的子图层。不同于那些绘制在父图层中的子图层，<code>mask</code>图层定义了父图层的部分可见区域。</p>
<p><code>mask</code>图层的<code>Color</code>属性是无关紧要的，真正重要的是图层的轮廓。<code>mask</code>属性就像是一个饼干切割机，<code>mask</code>图层实心的部分会被保留下来，其他的则会被抛弃</p>
<p>如果<code>mask</code>图层比父图层要小，只有在<code>mask</code>图层里面的内容才是它关心的，除此以外的一切都会被隐藏起来。</p>
<blockquote>
<p>//create mask layer<br>  CALayer <em>maskLayer = [CALayer layer];<br>  maskLayer.frame = self.layerView.bounds;<br>  UIImage </em>maskImage = [UIImage imageNamed:@”Cone.png”];<br>  maskLayer.contents = (__bridge id)maskImage.CGImage;</p>
<p>  //apply mask to image layer￼<br>  self.imageView.layer.mask = maskLayer;</p>
</blockquote>
<p>CALayer蒙板图层真正厉害的地方在于蒙板图不局限于静态图。任何有图层构成的都可以作为<code>mask</code>属性，这意味着你的蒙板可以通过代码甚至是动画实时生成。</p>
<p>当你显示一个50%透明度的图层时，图层的每个像素都会一般显示自己的颜色，另一半显示图层下面的颜色。这是正常的透明度的表现。但是如果图层包含一个同样显示50%透明的子图层时，你所看到的视图，50%来自子视图，25%来了图层本身的颜色，另外的25%则来自背景色。</p>
<h2 id="CATextLayer"><a href="#CATextLayer" class="headerlink" title="CATextLayer"></a>CATextLayer</h2><p>用户界面是无法从一个单独的图片里面构建的。一个设计良好的图标能够很好地表现一个按钮或控件的意图，不过你迟早都要需要一个不错的老式风格的文本标签。</p>
<p>如果你想在一个图层里面显示文字，完全可以借助图层代理直接将字符串使用Core Graphics写入图层的内容（这就是UILabel的精髓）。如果越过寄宿于图层的视图，直接在图层上操作，那其实相当繁琐。你要为每一个显示文字的图层创建一个能像图层代理一样工作的类，还要逻辑上判断哪个图层需要显示哪个字符串，更别提还要记录不同的字体，颜色等一系列乱七八糟的东西。</p>
<p>万幸的是这些都是不必要的，Core Animation提供了一个<code>CALayer</code>的子类<code>CATextLayer</code>，它以图层的形式包含了<code>UILabel</code>几乎所有的绘制特性，并且额外提供了一些新的特性。</p>
<p>同样，<code>CATextLayer</code>也要比<code>UILabel</code>渲染得快得多。很少有人知道在iOS 6及之前的版本，<code>UILabel</code>其实是通过WebKit来实现绘制的，这样就造成了当有很多文字的时候就会有极大的性能压力。而<code>CATextLayer</code>使用了Core text，并且渲染得非常快。</p>
<p>让我们来尝试用<code>CATextLayer</code>来显示一些文字。【用<code>CATextLayer</code>来显示一个纯文本标签】</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line">@interface ViewController ()</div><div class="line"></div><div class="line">@property (nonatomic, weak) IBOutlet UIView *labelView;</div><div class="line"></div><div class="line">@end</div><div class="line"></div><div class="line">@implementation ViewController</div><div class="line"></div><div class="line">- (void)viewDidLoad&#123;</div><div class="line"></div><div class="line">[super viewDidLoad];</div><div class="line"></div><div class="line">//create a text layer</div><div class="line"></div><div class="line">CATextLayer *textLayer = [CATextLayer layer];</div><div class="line"></div><div class="line">textLayer.frame = self.labelView.bounds;</div><div class="line"></div><div class="line">[self.labelView.layer addSublayer:textLayer];</div><div class="line"></div><div class="line">//set text attributes</div><div class="line"></div><div class="line">textLayer.foregroundColor = [UIColor blackColor].CGColor;</div><div class="line"></div><div class="line">textLayer.alignmentMode = kCAAlignmentJustified;</div><div class="line"></div><div class="line">textLayer.wrapped = YES;</div><div class="line"></div><div class="line">//choose a font</div><div class="line"></div><div class="line">UIFont *font = [UIFont systemFontOfSize:15];</div><div class="line"></div><div class="line">//set layer font</div><div class="line"></div><div class="line">CFStringRef fontName = (__bridge CFStringRef)font.fontName;</div><div class="line"></div><div class="line">CGFontRef fontRef = CGFontCreateWithFontName(fontName);</div><div class="line"></div><div class="line">textLayer.font = fontRef;</div><div class="line"></div><div class="line">textLayer.fontSize = font.pointSize;</div><div class="line"></div><div class="line">CGFontRelease(fontRef);</div><div class="line"></div><div class="line">//choose some text</div><div class="line"></div><div class="line">NSString *text = @&quot;Lorem ipsum dolor sit amet, consectetur adipiscing \ elit. Quisque massa arcu, eleifend vel varius in, facilisis pulvinar \ leo. Nunc quis nunc at mauris pharetra condimentum ut ac neque. Nunc elementum, libero ut porttitor dictum, diam odio congue lacus, vel \ fringilla sapien diam at purus. Etiam suscipit pretium nunc sit amet \ lobortis&quot;;</div><div class="line"></div><div class="line">//set layer text</div><div class="line"></div><div class="line">textLayer.string = text;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line">@end</div></pre></td></tr></table></figure>
<p>如果我们想以Retina的质量来显示文字，我们就得手动地设置<code>CATextLayer</code>的<code>contentsScale</code>属性，如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">textLayer.contentsScale = [UIScreen mainScreen].scale;</div></pre></td></tr></table></figure>
<h2 id="CATiledLayer"><a href="#CATiledLayer" class="headerlink" title="CATiledLayer"></a>CATiledLayer</h2><p>有些时候你可能需要绘制一个很大的图片，常见的例子就是一个高像素的照片或者是地球表面的详细地图。iOS应用通畅运行在内存受限的设备上，所以读取整个图片到内存中是不明智的。载入大图可能会相当地慢，那些对你看上去比较方便的做法（在主线程调用<code>UIImage</code>的<code>-imageNamed:</code>方法或者<code>-imageWithContentsOfFile:</code>方法）将会阻塞你的用户界面，至少会引起动画卡顿现象。</p>
<p>能高效绘制在iOS上的图片也有一个大小限制。所有显示在屏幕上的图片最终都会被转化为OpenGL纹理，同时OpenGL有一个最大的纹理尺寸（通常是2048*2048，或4096*4096，这个取决于设备型号）。如果你想在单个纹理中显示一个比这大的图，即便图片已经存在于内存中了，你仍然会遇到很大的性能问题，因为Core Animation强制用CPU处理图片而不是更快的GPU。</p>
<p><code>CATiledLayer</code>为载入大图造成的性能问题提供了一个解决方案：将大图分解成小片然后将他们单独按需载入。让我们用实验来证明一下。</p>
<h3 id="图片裁剪"><a href="#图片裁剪" class="headerlink" title="图片裁剪"></a>图片裁剪</h3><p>我们将会选择一张比较大的图片入手。为了能够从<code>CATiledLayer</code>中获益，我们需要把这个图片裁切成许多小一些的图片。你可以通过代码来完成这件事情，但是如果你在运行时读入整个图片并裁切，那<code>CATiledLayer</code>这些所有的性能优点就损失殆尽了。理想情况下来说，最好能够逐个步骤来实现。</p>
<p>下边演示了一个<a href="https://github.com/Chaiyahang/CATiledLayerDemo" target="_blank" rel="external">简单的Mac OS命令行程序</a>，它用<code>CATiledLayer</code>将一个图片裁剪成小图并存储到不同的文件中。</p>
<hr>
<p>动画类型取决于<em>图层行为</em></p>
<p>Core Animation是如何判断动画类型和持续时间的呢？实际上动画执行的时间取决于当前<em>事务</em>的设置，动画类型取决于<em>图层行为</em>。</p>
<p>事务实际上是Core Animation用来包含一系列属性动画集合的机制，任何用指定事务去改变可以做动画的图层属性都不会立刻发生变化，而是当事务一旦<em>提交</em>的时候开始用一个动画过渡到新值。</p>
<p>事务是通过<code>CATransaction</code>类来做管理，这个类的设计有些奇怪，不像你从它的命名预期的那样去管理一个简单的事务，而是管理了一叠你不能访问的事务。<code>CATransaction</code>没有属性或者实例方法，并且也不能用<code>+alloc</code>和<code>-init</code>方法创建它。但是可以用<code>+begin</code>和<code>+commit</code>分别来入栈或者出栈。</p>
<p>任何可以做动画的图层属性都会被添加到栈顶的事务，你可以通过<code>+setAnimationDuration:</code>方法设置当前事务的动画时间，或者通过<code>+animationDuration</code>方法来获取值（默认0.25秒）。</p>
<p>Core Animation在每个<em>run loop</em>周期中自动开始一次新的事务（run loop是iOS负责收集用户输入，处理定时器或者网络事件并且重新绘制屏幕的东西），即使你不显式的用<code>[CATransaction begin]</code>开始一次事务，任何在一次run loop循环中属性的改变都会被集中起来，然后做一次0.25秒的动画。</p>
<p>使用<code>CATransaction</code>控制动画时间</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">- (IBAction)changeColor</div><div class="line">&#123;</div><div class="line">    //begin a new transaction</div><div class="line">    [CATransaction begin];</div><div class="line">    //set the animation duration to 1 second</div><div class="line">    [CATransaction setAnimationDuration:1.0];</div><div class="line">    //randomize the layer background color</div><div class="line">    CGFloat red = arc4random() / (CGFloat)INT_MAX;</div><div class="line">    CGFloat green = arc4random() / (CGFloat)INT_MAX;</div><div class="line">    CGFloat blue = arc4random() / (CGFloat)INT_MAX;</div><div class="line">    self.colorLayer.backgroundColor = [UIColor colorWithRed:red green:green blue:blue alpha:1.0].CGColor;</div><div class="line">    ￼//commit the transaction</div><div class="line">    [CATransaction commit];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h6 id=""><a href="#" class="headerlink" title="================================================================================"></a>================================================================================</h6><figure class="highlight coq"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">velocity = <span class="built_in">change</span> / <span class="built_in">time</span></div></pre></td></tr></table></figure>
<p>现实生活中的任何一个物体都会在运动中加速或者减速。那么我们如何在动画中实现这种加速度呢？一种方法是使用<em>物理引擎</em>来对运动物体的摩擦和动量来建模，然而这会使得计算过于复杂。我们称这种类型的方程为<em>缓冲函数</em>，幸运的是，Core Animation内嵌了一系列标准函数提供给我们使用。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/02/27/UIView二三事/" data-id="cj46tfgxv0017o3s6nzy7s2tz" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/iOS/">iOS</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2017/03/14/ios代码签名探析/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          ios代码签名探析
        
      </div>
    </a>
  
  
    <a href="/2017/02/23/Best-Free-Apps-For-Mac/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Best Free Apps For Mac</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/iOS/">iOS</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/ios/">ios</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/图片/">图片</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/小说/">小说</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/工具/">工具</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/效率/">效率</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/文字/">文字</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/网络/">网络</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/网络/iOS/">iOS</a></li></ul></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Authentication/">Authentication</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CGRect/">CGRect</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/NSURLRequest/">NSURLRequest</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Objective-C/">Objective-C</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TouchID/">TouchID</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/git/">git</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/iOS/">iOS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ios/">ios</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/下载插件/">下载插件</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/不甘示弱/">不甘示弱</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/仓央嘉措/">仓央嘉措</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/偈子/">偈子</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/南工/">南工</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/历史/">历史</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/屏蔽广告/">屏蔽广告</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/工具/">工具</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/悔恨/">悔恨</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/我的母校/">我的母校</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/执子之手，共你一世风霜/">执子之手，共你一世风霜</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/文史/">文史</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/文字/">文字</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/文学/">文学</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/梦溪湖/">梦溪湖</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/湘西王/">湘西王</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/生命/">生命</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/网页歌曲/">网页歌曲</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/网页视频/">网页视频</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/表单上传/">表单上传</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/西原/">西原</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/见或不见/">见或不见</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/认真的雪/">认真的雪</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/陈渠珍/">陈渠珍</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Authentication/" style="font-size: 10px;">Authentication</a> <a href="/tags/CGRect/" style="font-size: 10px;">CGRect</a> <a href="/tags/NSURLRequest/" style="font-size: 10px;">NSURLRequest</a> <a href="/tags/Objective-C/" style="font-size: 13.33px;">Objective-C</a> <a href="/tags/TouchID/" style="font-size: 10px;">TouchID</a> <a href="/tags/git/" style="font-size: 10px;">git</a> <a href="/tags/iOS/" style="font-size: 20px;">iOS</a> <a href="/tags/ios/" style="font-size: 10px;">ios</a> <a href="/tags/下载插件/" style="font-size: 10px;">下载插件</a> <a href="/tags/不甘示弱/" style="font-size: 10px;">不甘示弱</a> <a href="/tags/仓央嘉措/" style="font-size: 10px;">仓央嘉措</a> <a href="/tags/偈子/" style="font-size: 10px;">偈子</a> <a href="/tags/南工/" style="font-size: 10px;">南工</a> <a href="/tags/历史/" style="font-size: 10px;">历史</a> <a href="/tags/屏蔽广告/" style="font-size: 10px;">屏蔽广告</a> <a href="/tags/工具/" style="font-size: 16.67px;">工具</a> <a href="/tags/悔恨/" style="font-size: 10px;">悔恨</a> <a href="/tags/我的母校/" style="font-size: 10px;">我的母校</a> <a href="/tags/执子之手，共你一世风霜/" style="font-size: 10px;">执子之手，共你一世风霜</a> <a href="/tags/文史/" style="font-size: 10px;">文史</a> <a href="/tags/文字/" style="font-size: 16.67px;">文字</a> <a href="/tags/文学/" style="font-size: 10px;">文学</a> <a href="/tags/梦溪湖/" style="font-size: 10px;">梦溪湖</a> <a href="/tags/湘西王/" style="font-size: 10px;">湘西王</a> <a href="/tags/生命/" style="font-size: 10px;">生命</a> <a href="/tags/网页歌曲/" style="font-size: 10px;">网页歌曲</a> <a href="/tags/网页视频/" style="font-size: 10px;">网页视频</a> <a href="/tags/表单上传/" style="font-size: 10px;">表单上传</a> <a href="/tags/西原/" style="font-size: 10px;">西原</a> <a href="/tags/见或不见/" style="font-size: 10px;">见或不见</a> <a href="/tags/认真的雪/" style="font-size: 10px;">认真的雪</a> <a href="/tags/陈渠珍/" style="font-size: 10px;">陈渠珍</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">April 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">March 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">February 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">January 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">December 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">November 2016</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2017/04/25/iOS推送机制/">iOS推送机制</a>
          </li>
        
          <li>
            <a href="/2017/03/21/ios应用程序的生命周期/"> ios应用程序的生命周期</a>
          </li>
        
          <li>
            <a href="/2017/03/20/OC内存管理/">OC内存管理</a>
          </li>
        
          <li>
            <a href="/2017/03/19/3·15晚会/">3·15晚会</a>
          </li>
        
          <li>
            <a href="/2017/03/17/NSString属性什么时候用copy，什么时候用strong/">NSString属性什么时候用copy，什么时候用strong?</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2017 柴亚航<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>